<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GraceWise v5.2 Lite</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
body{font-family:Inter,Arial,sans-serif;margin:0;padding:0;background:#f5f5f5;color:#111}
header{background:#004080;color:#fff;padding:10px;text-align:center;font-weight:600}
main{padding:10px;max-width:900px;margin:auto}
.panel{background:#fff;padding:10px;margin-bottom:12px;border-radius:6px}
label{display:block;margin-top:6px;font-size:13px}
input,select,button{padding:8px;border:1px solid #ccc;border-radius:4px;font-size:14px;width:100%;margin-top:4px}
button{background:#004080;color:#fff;cursor:pointer}
nav{position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:space-around;background:#fff;border-top:1px solid #ddd;padding:6px 0}
nav div{cursor:pointer;text-align:center;font-size:13px;color:#555}
nav .active{color:#004080;font-weight:600}
canvas{max-width:100%;}
.progress{height:10px;background:#ddd;border-radius:5px;margin-top:6px}
.bar{height:10px;background:#004080;border-radius:5px;width:0%;transition:width .3s}
.hidden{display:none}
</style>
</head>
<body>
<header>GraceWise v5.2 Lite</header>
<main>
<div id="cards" class="panel">
<h3>Cards / Banks</h3>
<label>Card Name<input id="bankName" value="Demo CIB Card"></label>
<label>Cycle End<input id="bankEnd" type="date"></label>
<label>Due Date<input id="bankDue" type="date"></label>
<label>Annual Rate (%)<input id="bankRate" type="number" value="24"></label>
<button id="saveBank">Save</button>
<div id="bankList"></div>
</div>

<div id="transactions" class="panel hidden">
<h3>Transactions</h3>
<select id="txCard"></select>
<label>Date<input id="txDate" type="date"></label>
<label>Amount (EGP)<input id="txAmount" type="number" value="1200"></label>
<button id="addTx">Add Transaction</button>
<div id="txList"></div>
</div>

<div id="grace" class="panel hidden">
<h3>Grace Analysis</h3>
<select id="analysisCard"></select>
<label>Purchase Date<input id="analysisDate" type="date"></label>
<button id="calcGrace">Calculate</button>
<div id="analysisResult"></div>
<div class="progress"><div class="bar" id="progressBar"></div></div>
<canvas id="weekChart" height="120"></canvas>
</div>

<div id="settings" class="panel hidden">
<h3>Settings</h3>
<button id="clearData">Clear All</button>
</div>
</main>
<nav>
<div data-tab="cards" class="active">Cards</div>
<div data-tab="transactions">Transactions</div>
<div data-tab="grace">Grace</div>
<div data-tab="settings">Settings</div>
</nav>
<script>
const BANKS_KEY='gw_banks',TX_KEY='gw_tx';
function load(k){try{return JSON.parse(localStorage.getItem(k)||'[]')}catch{return[]}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function uid(){return Math.random().toString(36).slice(2,9)}
function fmt(d){return d?new Date(d).toLocaleDateString():'-'}
function daysDiff(a,b){return Math.round((b-a)/(1000*60*60*24))}
function simpleInterest(a,r,d){const daily=(r/100)/365;return a*daily*d;}
function compoundInterest(a,r,d){const daily=(r/100)/365;return a*(Math.pow(1+daily,d)-1);}

function seed(){
  if(localStorage.getItem('lite_seeded'))return;
  const b={id:'demo',name:'Demo CIB',end:new Date().toISOString().slice(0,10),due:(()=>{let d=new Date();d.setMonth(d.getMonth()+1);d.setDate(15);return d.toISOString().slice(0,10);})(),rate:24};
  save(BANKS_KEY,[b]);
  const t=[{id:'t1',bankId:'demo',date:new Date().toISOString().slice(0,10),amount:1200}];
  save(TX_KEY,t);
  localStorage.setItem('lite_seeded','1');
}

function renderBanks(){
  const banks=load(BANKS_KEY);
  const list=document.getElementById('bankList');list.innerHTML='';
  const txSel=document.getElementById('txCard');txSel.innerHTML='';
  const aSel=document.getElementById('analysisCard');aSel.innerHTML='';
  banks.forEach(b=>{
    const d=document.createElement('div');
    d.textContent=`${b.name} - Due: ${fmt(b.due)}`;
    list.appendChild(d);
    const opt=document.createElement('option');opt.value=b.id;opt.textContent=b.name;txSel.appendChild(opt);
    const opt2=document.createElement('option');opt2.value=b.id;opt2.textContent=b.name;aSel.appendChild(opt2);
  });
}
function saveBank(){
  const b={id:uid(),name:document.getElementById('bankName').value,end:document.getElementById('bankEnd').value,due:document.getElementById('bankDue').value,rate:parseFloat(document.getElementById('bankRate').value)};
  const banks=load(BANKS_KEY);banks.push(b);save(BANKS_KEY,banks);renderBanks();
}
function addTx(){
  const txs=load(TX_KEY);
  const bankId=document.getElementById('txCard').value;
  const date=document.getElementById('txDate').value;
  const amount=parseFloat(document.getElementById('txAmount').value);
  txs.push({id:uid(),bankId,date,amount});
  save(TX_KEY,txs);
  renderTxs();
}
function renderTxs(){
  const txs=load(TX_KEY);const list=document.getElementById('txList');list.innerHTML='';
  txs.forEach(t=>{const d=document.createElement('div');d.textContent=`${fmt(t.date)} - EGP ${t.amount}`;list.appendChild(d);});
}
function calcGrace(){
  const banks=load(BANKS_KEY);
  const id=document.getElementById('analysisCard').value;
  const b=banks.find(x=>x.id===id);
  if(!b){document.getElementById('analysisResult').innerText='No card selected';return;}
  const p=new Date(document.getElementById('analysisDate').value);
  const endDay=new Date(b.end).getDate(),dueDay=new Date(b.due).getDate();
  let end=new Date(p.getFullYear(),p.getMonth(),endDay);
  if(p.getDate()>endDay){end.setMonth(end.getMonth()+1);}
  let due=new Date(end.getFullYear(),end.getMonth()+1,dueDay);
  // adjust day overflow
  const daysInMonth = new Date(due.getFullYear(), due.getMonth()+1, 0).getDate();
  if(due.getDate() > daysInMonth){ due.setDate(daysInMonth); }
  const grace=daysDiff(p,due);
  document.getElementById('analysisResult').innerHTML=`Grace: ${grace} days (Due ${fmt(due)})`;
  const totalWindow = grace>0?grace:1;
  const elapsed = daysDiff(p,new Date());
  const prog = Math.min(100, Math.max(0, Math.round((elapsed/totalWindow)*100)));
  document.getElementById('progressBar').style.width=prog+'%';
  buildChart(due);
}
function buildChart(due){
  const ctx=document.getElementById('weekChart').getContext('2d');
  const today=new Date();
  const start=new Date(today);start.setDate(today.getDate()-today.getDay());
  const labels=[],data=[];
  for(let i=0;i<7;i++){const d=new Date(start);d.setDate(start.getDate()+i);labels.push(d.toLocaleDateString('en-US',{weekday:'short'}));data.push(daysDiff(d,due));}
  if(window.wChart)window.wChart.destroy();
  window.wChart=new Chart(ctx,{type:'bar',data:{labels, datasets:[{label:'Grace days', data, backgroundColor:'#004080'}]}, options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
}
function clearData(){localStorage.clear();location.reload();}
document.querySelectorAll('nav div').forEach(el=>el.onclick=()=>{
  document.querySelectorAll('main > div').forEach(d=>d.classList.add('hidden'));
  document.querySelectorAll('nav div').forEach(n=>n.classList.remove('active'));
  document.getElementById(el.dataset.tab).classList.remove('hidden');
  el.classList.add('active');
});
document.getElementById('saveBank').onclick=saveBank;
document.getElementById('addTx').onclick=addTx;
document.getElementById('calcGrace').onclick=calcGrace;
document.getElementById('clearData').onclick=clearData;
seed();renderBanks();renderTxs();
</script>
</body>
</html>