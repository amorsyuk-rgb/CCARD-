<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GraceWise v5 Full (Enhanced Grace Analysis)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --cib-blue:#005BAC; --cib-orange:#F37021; --cib-bg:#F8F9FB; --cib-text:#1B1B1B; --okx-bg:#0b0f14; --okx-text:#e6eef3; --muted:#76808a;
  --safe:#10b981; --warning:#f59e0b; --critical:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--cib-bg);color:var(--cib-text)}
.container{max-width:1100px;margin:12px auto;padding:8px}
.header{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;background:linear-gradient(90deg,var(--cib-blue),var(--cib-orange));color:white;box-shadow:0 6px 20px rgba(5,30,60,0.12);gap:12px}
.brand{display:flex;align-items:center;gap:12px}
.logo-wrap{width:44px;height:44px;border-radius:8px;background:rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:18px}
.title{font-weight:700;font-size:16px}
.subtitle{font-size:12px;opacity:0.95}
.header-controls{display:flex;gap:8px;align-items:center}
.icon-btn{background:rgba(255,255,255,0.12);border:0;color:white;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:6px}
.main{display:flex;gap:12px;margin-top:12px}
.left{width:360px}
.right{flex:1}
.panel{background:white;border-radius:10px;padding:12px;box-shadow:0 6px 20px rgba(10,20,30,0.04);margin-bottom:12px}
.dark .panel{background:#0f1419;color:var(--okx-text)}
.tab-section{display:none}
.tab-section.active{display:block}
label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
input,select,textarea,button{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ee;background:white;font-size:14px}
.dark input,.dark select,.dark textarea{background:#0b0f14;border:1px solid rgba(255,255,255,0.04);color:var(--okx-text)}
.bank-item, .tx-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;border:1px solid #eef2f5;margin-top:8px;background:transparent}
.dark .bank-item,.dark .tx-row{border-color:rgba(255,255,255,0.03)}
.bottom-nav{position:fixed;left:0;right:0;bottom:0;height:64px;background:rgba(255,255,255,0.98);display:flex;justify-content:space-around;align-items:center;border-top:1px solid #e6e9ee;z-index:50}
.bottom-nav .nav-item{flex:1;display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;padding:10px 6px;color:var(--muted);font-weight:600}
.bottom-nav .nav-item.active{color:var(--cib-blue);background:linear-gradient(90deg, rgba(0,90,180,0.06), rgba(243,112,33,0.03));box-shadow:inset 0 0 0 1px rgba(0,90,180,0.02)}
.material-icons-outlined{font-size:20px}
@media(max-width:900px){.main{flex-direction:column}.left{width:100%}.bottom-nav{height:72px}}
.small{font-size:13px;color:var(--muted)}
/* Splash with fade-out */
#splash{position:fixed;inset:0;background:linear-gradient(90deg,var(--cib-blue),var(--cib-orange));display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column;color:white;opacity:1;transition:opacity 0.5s ease}
#splash.hidden{opacity:0;pointer-events:none}
.splash-box{width:140px;height:140px;border-radius:18px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.06);font-weight:800;font-size:44px}
.splash-sub{margin-top:12px;opacity:0.95;font-size:14px}
.hidden{display:none}
.small-btn{background:#f3f4f6;border-radius:8px;padding:8px 10px;border:0;cursor:pointer}
.dark .small-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--okx-text)}
.footer{font-size:13px;color:var(--muted);margin-top:12px;text-align:center}
.progress-wrap{width:100%;height:10px;background:#e6e6e6;border-radius:6px;margin-top:8px;overflow:hidden}
.progress-bar{height:100%;border-radius:6px;transition:width 0.3s ease}
.dark .progress-wrap{background:#1a1f27}
.dark .progress-bar{background:linear-gradient(90deg,#00a3ff,#9b59b6)}

/* Enhanced Grace Analysis Styles */
.enhanced-grace-panel{margin-top:16px;padding:16px;background:rgba(0,0,0,0.02);border-radius:10px}
.timeline-header{display:flex;justify-content:space-between;font-size:12px;color:var(--muted)}
.metrics-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:12px 0}
.metric-card{padding:12px;background:white;border-radius:8px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.04)}
.dark .metric-card{background:#0b0f14}
.metric-value{font-size:20px;font-weight:700}
.metric-label{font-size:12px;color:var(--muted);margin-top:4px}
.status-alert{padding:12px;border-radius:8px;font-size:14px;margin-top:12px}
.status-safe{background:#ecfdf5;border-left:4px solid var(--safe)}
.status-warning{background:#fffbeb;border-left:4px solid var(--warning)}
.status-critical{background:#fef2f2;border-left:4px solid var(--critical)}
.dark .status-safe{background:rgba(16,185,129,0.1)}
.dark .status-warning{background:rgba(245,158,11,0.1)}
.dark .status-critical{background:rgba(239,68,68,0.1)}
.scenario-card{border:1px solid #e6e9ee;border-radius:8px;padding:12px;margin-top:8px;background:white}
.dark .scenario-card{background:#0b0f14;border-color:rgba(255,255,255,0.06)}
.scenario-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.scenario-date{font-weight:600;font-size:14px}
.scenario-status{padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600}
.status-badge-safe{background:var(--safe);color:white}
.status-badge-warning{background:var(--warning);color:white}
.status-badge-critical{background:var(--critical);color:white}
</style>
</head>
<body>
<div id="splash">
  <div class="splash-box">GW</div>
  <div class="splash-sub">GraceWise — Smart Credit Dashboard</div>
</div>

<div id="app" class="container" style="display:none">
  <div class="header" id="header">
    <div class="brand">
      <div class="logo-wrap" id="logo">GW</div>
      <div>
        <div class="title">GraceWise</div>
        <div class="subtitle">Smart Credit Dashboard</div>
      </div>
    </div>
    <div class="header-controls">
      <button class="icon-btn" id="themeToggle"><span class="material-icons-outlined">brightness_6</span>Theme</button>
      <button class="icon-btn" id="exportBtn"><span class="material-icons-outlined">save_alt</span>Export</button>
    </div>
  </div>

  <div class="main">
    <div class="left">
      <div class="panel">
        <div id="tabCards" class="tab-section">
          <h3>Cards / Banks</h3>
          <div class="small">Create or edit cards. Annual rate & default interest method.</div>
          <label>Card name<input id="bankName" placeholder="e.g. CIB Mastercard"></label>
          <label>Cycle Start<input id="bankStart" type="date"></label>
          <label>Cycle End<input id="bankEnd" type="date"></label>
          <label>Due Date<input id="bankDue" type="date"></label>
          <label>Annual Rate (%)<input id="bankRate" type="number" step="0.01" placeholder="e.g. 24"></label>
          <label>Default Interest Method<select id="bankMethod"><option value="simple">Simple</option><option value="compound">Compound (daily)</option></select></label>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="saveBank">Save / Update</button>
            <button id="newBank" class="small-btn">New</button>
          </div>
          <div id="banksList"></div>
        </div>

        <div id="tabSettings" class="tab-section">
          <h3>Settings</h3>
          <div class="small">Theme, export/import, reset data, and app info.</div>
          <label>Theme<select id="settingsTheme"><option value="cib">CIB Light</option><option value="dark">Dark OKX</option></select></label>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="exportAll" class="small-btn">Export JSON</button>
            <label class="small-btn" style="display:inline-block;cursor:pointer">Import JSON <input id="importFile" type="file" accept="application/json" style="display:none"></label>
          </div>
          <div style="margin-top:8px">
            <button id="clearData" class="small-btn">Clear All Data</button>
            <button id="restoreDefaults" class="small-btn">Restore Defaults</button>
          </div>
          <div class="footer">GraceWise v5.0 © 2025 — Designed for smart credit insights.</div>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="panel">
        <div id="tabTx" class="tab-section active">
          <h3>Transactions</h3>
          <div class="small">Register purchases, track due dates and interest.</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <select id="txCard"></select>
            <input id="txDate" type="date" style="width:150px">
            <input id="txAmount" type="number" placeholder="EGP" style="width:120px">
          </div>
          <label>Description<input id="txDesc" placeholder="Merchant or note"></label>
          <label>Interest method override<select id="txMethod"><option value="">Use card default</option><option value="simple">Simple</option><option value="compound">Compound</option></select></label>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="addTx">Add Transaction</button>
            <button id="clearTx" class="small-btn">Clear</button>
          </div>
          <div id="txPanel" style="margin-top:12px;display:none">
            <h4>Transactions list</h4>
            <div id="txList"></div>
          </div>
        </div>

        <div id="tabGrace" class="tab-section">
          <h3>Grace Analysis</h3>
          <div class="small">Choose a card and a purchase date to calculate the grace period. This simulates the repeating monthly cycle.</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <select id="analysisCard" style="flex:1"></select>
            <input id="analysisDate" type="date" style="width:180px">
            <button id="analysisNow" class="small-btn" style="width:120px">Calculate</button>
          </div>
          
          <!-- Enhanced Grace Analysis Panel -->
          <div class="enhanced-grace-panel">
            <h4>Enhanced Grace Analysis</h4>
            
            <!-- Timeline Visualization -->
            <div id="graceTimeline" style="margin: 12px 0;">
              <div class="timeline-header">
                <span>Purchase</span>
                <span>Today</span>
                <span>Due Date</span>
              </div>
              <div class="progress-wrap" style="margin: 8px 0;">
                <div id="timelineProgress" class="progress-bar" style="width: 0%; height: 8px; border-radius: 4px;"></div>
              </div>
            </div>

            <!-- Key Metrics -->
            <div class="metrics-grid" id="graceMetrics">
              <div class="metric-card">
                <div class="metric-value" id="daysRemaining">-</div>
                <div class="metric-label">Days Remaining</div>
              </div>
              <div class="metric-card">
                <div class="metric-value" id="utilizationPercent">-</div>
                <div class="metric-label">Grace Used</div>
              </div>
              <div class="metric-card">
                <div class="metric-value" id="totalGraceDays">-</div>
                <div class="metric-label">Total Grace</div>
              </div>
              <div class="metric-card">
                <div class="metric-value" id="daysUtilized">-</div>
                <div class="metric-label">Days Used</div>
              </div>
            </div>

            <!-- Status Alert -->
            <div id="graceStatus" class="status-alert" style="display:none;"></div>
          </div>

          <!-- Multiple Scenarios Section -->
          <div style="margin-top: 20px;">
            <h4>Quick Scenarios</h4>
            <div class="small">Analyze multiple purchase dates at once</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input type="date" id="scenarioDate" style="flex:1">
              <button id="addScenario" class="small-btn" style="width:100px">Add Scenario</button>
            </div>
            <div id="scenariosList" style="margin-top:12px"></div>
          </div>

          <!-- Original Analysis Box (kept for compatibility) -->
          <div id="analysisBox" style="margin-top:12px;border-radius:10px;padding:12px;background:linear-gradient(180deg,rgba(0,0,0,0.03),transparent)">
            <div id="analysisSummary" style="font-size:14px"></div>
            <div class="progress-wrap" style="margin-top:10px"><div id="analysisProgress" class="progress-bar" style="width:0%"></div></div>
          </div>
          
          <div style="margin-top:16px">
            <canvas id="analysisWeekChart"></canvas>
          </div>
        </div>

        <div id="tabInsights" class="tab-section">
          <h3>Insights</h3>
          <div class="small">Aggregated totals, overdue distribution, and per-card charts.</div>
          <div id="insightsContent"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="bottom-nav" id="bottomNav">
    <div class="nav-item" data-target="tabCards"><span class="material-icons-outlined">account_balance</span><span>Cards</span></div>
    <div class="nav-item" data-target="tabTx"><span class="material-icons-outlined">credit_card</span><span>Transactions</span></div>
    <div class="nav-item active" data-target="tabGrace"><span class="material-icons-outlined">show_chart</span><span>Grace</span></div>
    <div class="nav-item" data-target="tabInsights"><span class="material-icons-outlined">insights</span><span>Insights</span></div>
    <div class="nav-item" data-target="tabSettings"><span class="material-icons-outlined">settings</span><span>Settings</span></div>
  </div>
</div>

<script>
/* Storage keys */
const BANKS_KEY='gw_v4_banks', TX_KEY='gw_v4_tx', THEME_KEY='gw_v4_theme', LAST_TAB='gw_v4_last_tab', SCENARIOS_KEY='gw_v4_scenarios';

/* Utilities */
function uid(){return Math.random().toString(36).slice(2,9)}
function load(k){try{return JSON.parse(localStorage.getItem(k)||'[]')}catch{return[]}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function setVal(k,v){localStorage.setItem(k,v)}
function getVal(k){return localStorage.getItem(k)}
function fmt(d){return d?new Date(d).toLocaleDateString():'-'}
function parseDate(v){return v?new Date(v+'T00:00:00'):null}
function daysDiff(a,b){return Math.round((b-a)/(1000*60*60*24))}
function toEGP(n){return 'EGP '+Number(n||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}

/* interest */
function simpleInterest(amount,annual,days){const daily=(annual/100)/365;return amount*daily*days}
function compoundInterest(amount,annual,days){const daily=(annual/100)/365;return amount*(Math.pow(1+daily,days)-1)}

/* Theme */
let theme = getVal(THEME_KEY) || 'cib';
function applyTheme(){ 
  if(theme==='dark'){
    document.documentElement.classList.add('dark'); 
    document.body.style.background='linear-gradient(180deg,#02040a,#071018)'; 
    document.querySelector('.header').style.background='linear-gradient(90deg,#071025,#00122b)'; 
  } else { 
    document.documentElement.classList.remove('dark'); 
    document.body.style.background='var(--cib-bg)'; 
    document.querySelector('.header').style.background='linear-gradient(90deg,var(--cib-blue),var(--cib-orange))'; 
  } 
  setVal(THEME_KEY,theme); 
  if(document.getElementById('settingsTheme')) document.getElementById('settingsTheme').value=theme; 
}

/* Safe init with error capture */
function safeInit(){
  try{
    init();
  }catch(err){
    console.error('Initialization error', err);
    const app=document.getElementById('app');
    app.style.display='block';
    const sum=document.getElementById('analysisSummary');
    if(sum) sum.innerHTML = '<div style="color:red">App initialization failed — check console for details.</div>';
  } finally {
    const splash=document.getElementById('splash');
    if(splash){
      splash.classList.add('hidden');
      setTimeout(()=>{ splash.style.display='none'; }, 500);
    }
  }
}

/* Splash hide */
document.addEventListener('DOMContentLoaded', ()=>{
  setTimeout(()=>{ safeInit(); }, 800);
});

/* Init */
function init(){
  applyTheme();
  bindUI();
  renderBanks();
  renderTxCards();
  populateAnalysisCards();
  const last = getVal(LAST_TAB) || 'tabGrace';
  openTab(last);
  document.querySelectorAll('.bottom-nav .nav-item').forEach(n=>{ n.classList.toggle('active', n.dataset.target===last); });
  
  // Initialize scenarios
  renderScenarios();
  
  const banks = load(BANKS_KEY);
  if(banks.length){
    renderTxCards();
  }
}

/* Bind UI events */
function bindUI(){
  document.getElementById('themeToggle').onclick = ()=>{ theme = (theme==='cib'?'dark':'cib'); applyTheme(); };
  document.getElementById('exportBtn').onclick = exportData;
  document.getElementById('saveBank').onclick = saveBank;
  document.getElementById('newBank').onclick = ()=>{ document.getElementById('bankName').value=''; document.getElementById('bankStart').value=''; document.getElementById('bankEnd').value=''; document.getElementById('bankDue').value=''; document.getElementById('bankRate').value=''; };
  document.getElementById('addTx').onclick = addTransaction;
  document.getElementById('clearTx').onclick = ()=>{ document.getElementById('txDate').value=''; document.getElementById('txAmount').value=''; document.getElementById('txDesc').value=''; document.getElementById('txMethod').value=''; };
  document.querySelectorAll('.bottom-nav .nav-item').forEach(n=>n.addEventListener('click', ()=>{ openTab(n.dataset.target); document.querySelectorAll('.bottom-nav .nav-item').forEach(x=>x.classList.remove('active')); n.classList.add('active'); setVal(LAST_TAB,n.dataset.target); }));
  const settingsTheme = document.getElementById('settingsTheme');
  if(settingsTheme) settingsTheme.addEventListener('change', (e)=>{ theme = e.target.value; applyTheme(); });
  const exportAll = document.getElementById('exportAll'); if(exportAll) exportAll.addEventListener('click', exportData);
  const importFile = document.getElementById('importFile'); if(importFile) importFile.addEventListener('change', importData);
  const clearDataBtn = document.getElementById('clearData'); if(clearDataBtn) clearDataBtn.addEventListener('click', clearAllData);
  const restoreDefaultsBtn = document.getElementById('restoreDefaults'); if(restoreDefaultsBtn) restoreDefaultsBtn.addEventListener('click', restoreDefaults);
  
  // Enhanced grace analysis events
  document.getElementById('analysisNow').addEventListener('click', updateGraceAnalysis);
  document.getElementById('addScenario').addEventListener('click', addScenario);
  
  // Auto-calculate when date changes
  document.getElementById('analysisDate').addEventListener('change', updateGraceAnalysis);
  document.getElementById('analysisCard').addEventListener('change', updateGraceAnalysis);
}

/* Tabs */
function openTab(id){
  document.querySelectorAll('.tab-section').forEach(s=>s.classList.remove('active'));
  const el=document.getElementById(id);
  if(el) el.classList.add('active');
  if(id==='tabTx' && load(TX_KEY).length>0) document.getElementById('txPanel').style.display='block'; else { const txPanel = document.getElementById('txPanel'); if(txPanel) txPanel.style.display='none'; }
  setVal(LAST_TAB,id);
}

/* Banks */
function renderBanks(){
  const banks = load(BANKS_KEY);
  const banksList = document.getElementById('banksList');
  const txCard = document.getElementById('txCard');
  banksList.innerHTML=''; if(txCard) txCard.innerHTML='';
  if(!banks.length){ banksList.innerHTML='<div class="small">No cards yet.</div>'; if(txCard) txCard.innerHTML='<option value=\"\">No card</option>'; return; }
  banks.forEach(b=>{
    const div=document.createElement('div'); div.className='bank-item';
    div.innerHTML = `<div><strong>${b.name}</strong><div class="small">${fmt(b.start)} → ${fmt(b.end)}</div><div class="small">Due ${fmt(b.due)} • ${b.rate}% • ${b.method}</div></div><div><button class="small-btn" data-id="${b.id}">Open</button></div>`;
    div.querySelector('button').onclick = ()=>{ openTab('tabCards'); document.getElementById('bankName').value=b.name; document.getElementById('bankStart').value=b.start; document.getElementById('bankEnd').value=b.end; document.getElementById('bankDue').value=b.due; document.getElementById('bankRate').value=b.rate; document.getElementById('bankMethod').value=b.method; };
    banksList.appendChild(div);
    if(txCard){ const opt=document.createElement('option'); opt.value=b.id; opt.textContent=b.name; txCard.appendChild(opt); }
  });
}

/* Save bank */
function saveBank(){
  const name=document.getElementById('bankName').value.trim(); const start=document.getElementById('bankStart').value; const end=document.getElementById('bankEnd').value; const due=document.getElementById('bankDue').value; const rate=parseFloat(document.getElementById('bankRate').value); const method=document.getElementById('bankMethod').value;
  if(!name||!start||!end||!due||isNaN(rate)){ alert('Please fill all card fields'); return; }
  const banks = load(BANKS_KEY); const existing = banks.find(x=>x.name.toLowerCase()===name.toLowerCase());
  if(existing){ existing.start=start; existing.end=end; existing.due=due; existing.rate=rate; existing.method=method; } else { banks.push({id:uid(),name,start,end,due,rate,method}); }
  save(BANKS_KEY,banks); renderBanks(); alert('Saved'); document.getElementById('bankName').value=''; renderTxCards();
}

/* Transactions */
function renderTxCards(){ const banks=load(BANKS_KEY); const sel=document.getElementById('txCard'); if(!sel) return; sel.innerHTML=''; if(!banks.length){ sel.innerHTML='<option value=\"\">No card</option>'; return;} banks.forEach(b=>{ const opt=document.createElement('option'); opt.value=b.id; opt.textContent=b.name; sel.appendChild(opt); }); }
function addTransaction(){ const bankId=document.getElementById('txCard').value; const date=document.getElementById('txDate').value; const amt=parseFloat(document.getElementById('txAmount').value); const desc=document.getElementById('txDesc')?document.getElementById('txDesc').value.trim():''; const method=document.getElementById('txMethod')?document.getElementById('txMethod').value:null; if(!bankId||!date||isNaN(amt)||amt<=0){ alert('Fill transaction fields'); return; } const banks=load(BANKS_KEY); const b=banks.find(x=>x.id===bankId); if(!b){ alert('Card not found'); return; } const txs=load(TX_KEY); txs.push({id:uid(),bankId,date,amount:Math.round(amt*100)/100,desc,methodOverride:method}); save(TX_KEY,txs); alert('Transaction added'); buildTxPanel(b); }

function buildTxPanel(bank){
  const txs = load(TX_KEY).filter(t=>t.bankId===bank.id).sort((a,b)=>new Date(a.date)-new Date(b.date));
  const txList = document.getElementById('txList'); if(!txList) return; txList.innerHTML=''; let sumP=0,sumI=0; let counts={active:0,near:0,over:0}; const today=new Date();
  txs.forEach(tx=>{ const purchase=new Date(tx.date+'T00:00:00'); const calc=calculateDueForCycle(bank,purchase); const due=calc.due; const grace=daysDiff(purchase,due); const overdue=Math.max(0,daysDiff(due,today)); const method=tx.methodOverride||bank.method; let interest=0; let total=tx.amount; if(overdue>0){ if(method==='compound') interest=compoundInterest(tx.amount,bank.rate,overdue); else interest=simpleInterest(tx.amount,bank.rate,overdue); total=tx.amount+interest; } sumP+=tx.amount; sumI+=interest; const div=document.createElement('div'); div.className='tx-row'; div.innerHTML=`<div><strong>${tx.desc||'Purchase'}</strong><div class="small">${fmt(purchase)} • Due ${fmt(due)} • Grace ${grace}d</div></div><div style="text-align:right"><div style="font-weight:700">${toEGP(tx.amount)}</div><div class="small">Interest: ${toEGP(interest)}</div><div class="small">Total: ${toEGP(total)}</div></div>`; txList.appendChild(div); });
}

/* Enhanced Grace Analysis Functions */
function createEnhancedGraceTimeline(bank, purchaseDate) {
  const calc = calculateDueForCycle(bank, purchaseDate);
  const today = new Date();
  const totalGrace = daysDiff(purchaseDate, calc.due);
  const daysUsed = daysDiff(purchaseDate, today);
  const daysRemaining = daysDiff(today, calc.due);
  
  return {
    timeline: [
      { event: 'Purchase', date: purchaseDate, type: 'start' },
      { event: 'Today', date: today, type: 'current' },
      { event: 'Due Date', date: calc.due, type: 'end' }
    ],
    metrics: {
      totalGrace,
      daysUsed: Math.max(0, Math.min(daysUsed, totalGrace)),
      daysRemaining: Math.max(0, daysRemaining),
      utilization: totalGrace > 0 ? (daysUsed / totalGrace * 100) : 0
    },
    dates: {
      purchase: purchaseDate,
      due: calc.due,
      cycleEnd: calc.cycleEnd
    }
  };
}

function updateEnhancedGraceAnalysis() {
  const bankId = document.getElementById('analysisCard').value;
  const purchaseInput = document.getElementById('analysisDate').value;
  
  if (!bankId || !purchaseInput) return;
  
  const banks = load(BANKS_KEY);
  const bank = banks.find(b => b.id === bankId);
  const purchaseDate = new Date(purchaseInput + 'T00:00:00');
  
  const timeline = createEnhancedGraceTimeline(bank, purchaseDate);
  updateGraceTimelineUI(timeline);
  updateGraceMetricsUI(timeline.metrics);
  updateGraceStatus(timeline.metrics);
}

function updateGraceTimelineUI(timeline) {
  const progressEl = document.getElementById('timelineProgress');
  if (progressEl) {
    const progress = timeline.metrics.utilization;
    progressEl.style.width = Math.min(100, progress) + '%';
    
    // Color coding based on utilization
    if (progress >= 80) {
      progressEl.style.background = '#ef4444';
    } else if (progress >= 60) {
      progressEl.style.background = '#f59e0b';
    } else {
      progressEl.style.background = '#10b981';
    }
  }
}

function updateGraceMetricsUI(metrics) {
  const daysRemainingEl = document.getElementById('daysRemaining');
  const utilizationEl = document.getElementById('utilizationPercent');
  const totalGraceEl = document.getElementById('totalGraceDays');
  const daysUtilizedEl = document.getElementById('daysUtilized');
  
  if (daysRemainingEl) daysRemainingEl.textContent = metrics.daysRemaining;
  if (utilizationEl) utilizationEl.textContent = Math.round(metrics.utilization) + '%';
  if (totalGraceEl) totalGraceEl.textContent = metrics.totalGrace;
  if (daysUtilizedEl) daysUtilizedEl.textContent = metrics.daysUsed;
}

function updateGraceStatus(metrics) {
  const statusEl = document.getElementById('graceStatus');
  if (!statusEl) return;
  
  let message = '';
  let statusClass = '';
  
  if (metrics.daysRemaining <= 0) {
    message = '⚠️ <strong>Grace period expired!</strong> Payment is due immediately to avoid interest charges.';
    statusClass = 'status-critical';
  } else if (metrics.daysRemaining <= 3) {
    message = '⚠️ <strong>Grace period ending soon.</strong> Plan your payment within the next 3 days.';
    statusClass = 'status-critical';
  } else if (metrics.daysRemaining <= 7) {
    message = 'ℹ️ <strong>Grace period active.</strong> Consider scheduling payment this week.';
    statusClass = 'status-warning';
  } else {
    message = '✅ <strong>Healthy grace period remaining.</strong> You have plenty of time for payment.';
    statusClass = 'status-safe';
  }
  
  statusEl.innerHTML = message;
  statusEl.className = `status-alert ${statusClass}`;
  statusEl.style.display = 'block';
}

/* Scenarios Management */
function addScenario() {
  const dateInput = document.getElementById('scenarioDate').value;
  if (!dateInput) {
    alert('Please select a date for the scenario');
    return;
  }
  
  const scenarios = load(SCENARIOS_KEY);
  if (!scenarios.find(s => s.date === dateInput)) {
    scenarios.push({ id: uid(), date: dateInput });
    save(SCENARIOS_KEY, scenarios);
    renderScenarios();
  }
  
  document.getElementById('scenarioDate').value = '';
}

function renderScenarios() {
  const scenarios = load(SCENARIOS_KEY);
  const container = document.getElementById('scenariosList');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (scenarios.length === 0) {
    container.innerHTML = '<div class="small">No scenarios added yet.</div>';
    return;
  }
  
  const bankId = document.getElementById('analysisCard').value;
  const banks = load(BANKS_KEY);
  const bank = banks.find(b => b.id === bankId);
  
  if (!bank) {
    container.innerHTML = '<div class="small">Select a card first.</div>';
    return;
  }
  
  scenarios.forEach(scenario => {
    const purchaseDate = new Date(scenario.date + 'T00:00:00');
    const timeline = createEnhancedGraceTimeline(bank, purchaseDate);
    
    const card = document.createElement('div');
    card.className = 'scenario-card';
    
    let statusClass = 'status-badge-safe';
    let statusText = 'Safe';
    if (timeline.metrics.daysRemaining <= 3) {
      statusClass = 'status-badge-critical';
      statusText = 'Critical';
    } else if (timeline.metrics.daysRemaining <= 7) {
      statusClass = 'status-badge-warning';
      statusText = 'Warning';
    }
    
    card.innerHTML = `
      <div class="scenario-header">
        <div class="scenario-date">${fmt(purchaseDate)}</div>
        <div class="scenario-status ${statusClass}">${statusText}</div>
      </div>
      <div class="small">
        Due: ${fmt(timeline.dates.due)} | 
        Remaining: ${timeline.metrics.daysRemaining} days | 
        Used: ${Math.round(timeline.metrics.utilization)}%
      </div>
      <button class="small-btn" data-date="${scenario.date}" style="margin-top:8px;width:100%">Use This Date</button>
    `;
    
    card.querySelector('button').addEventListener('click', function() {
      document.getElementById('analysisDate').value = this.dataset.date;
      updateGraceAnalysis();
    });
    
    container.appendChild(card);
  });
}

/* Charts */
let analysisWeekChart = null;
function buildGraceWeekChart(due){
  const canvas = document.getElementById('analysisWeekChart');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const today = new Date(); const start = new Date(today); start.setDate(today.getDate() - today.getDay()); start.setHours(0,0,0,0);
  const labels=[], data=[], bg=[];
  for(let i=0;i<7;i++){ const d=new Date(start); d.setDate(start.getDate()+i); labels.push(d.toLocaleDateString('en-US',{weekday:'short'})); const gd = daysDiff(d,due); data.push(gd); if(theme==='dark'){ bg.push(gd>=30? '#00a3ff' : (gd>=15? '#9b59b6' : '#ff6b6b')); } else { bg.push(gd>=30? '#005BAC': (gd>=15? '#F37021' : '#ff6b6b')); } }
  if(analysisWeekChart) analysisWeekChart.destroy();
  analysisWeekChart = new Chart(ctx, { type:'bar', data:{ labels:labels, datasets:[{ label:'Grace days', data:data, backgroundColor:bg }] }, options:{ responsive:true, plugins:{ legend:{ display:false }, title:{ display:true, text:"This Week's Grace Overview" } }, scales:{ y:{ beginAtZero:true } } } });
}

/* Grace Analysis integration */
function populateAnalysisCards(){
  const sel = document.getElementById('analysisCard');
  if(!sel) return;
  sel.innerHTML = '';
  const banks = load(BANKS_KEY);
  if(!banks || !banks.length){ sel.innerHTML = '<option value=\"\">No cards</option>'; return; }
  banks.forEach(b=>{ const opt = document.createElement('option'); opt.value = b.id; opt.textContent = b.name; sel.appendChild(opt); });
  const last = getVal('gw_analysis_card') || (banks[0] && banks[0].id);
  if(last) { sel.value = last; }
}

function calculateDueForCycle(bank, purchaseDate){
  const endDate = new Date(bank.end); const dueDateRef = new Date(bank.due);
  const purchase = new Date(purchaseDate.getFullYear(), purchaseDate.getMonth(), purchaseDate.getDate());
  const endDay = endDate.getDate(); const dueDay = dueDateRef.getDate();
  let cycleEndMonth = purchase.getMonth(); let cycleEndYear = purchase.getFullYear();
  if(purchase.getDate() > endDay){ cycleEndMonth = cycleEndMonth + 1; if(cycleEndMonth > 11){ cycleEndMonth = 0; cycleEndYear += 1; } }
  const cycleEnd = new Date(cycleEndYear, cycleEndMonth, endDay);
  let dueMonth = cycleEnd.getMonth() + 1; let dueYear = cycleEnd.getFullYear();
  if(dueMonth > 11){ dueMonth = 0; dueYear += 1; }
  const daysInMonth = new Date(dueYear, dueMonth+1, 0).getDate();
  const dueDayAdjusted = Math.min(dueDay, daysInMonth);
  const due = new Date(dueYear, dueMonth, dueDayAdjusted);
  return { cycleEnd, due };
}

function updateGraceAnalysis(){
  const sel = document.getElementById('analysisCard');
  const banks = load(BANKS_KEY);
  if(!banks || !banks.length){ 
    document.getElementById('analysisSummary').innerHTML = '<div class=\"small\">No cards saved. Add a card in Cards / Banks.</div>'; 
    return; 
  }
  const bank = banks.find(b=>b.id===sel.value) || banks[0];
  setVal('gw_analysis_card', bank.id);
  const purchaseInput = document.getElementById('analysisDate').value;
  if(!purchaseInput){ 
    document.getElementById('analysisSummary').innerHTML = '<div class=\"small\">Select a purchase date.</div>'; 
    return; 
  }
  const purchase = new Date(purchaseInput + 'T00:00:00');
  const calc = calculateDueForCycle(bank, purchase);
  const cycleEnd = calc.cycleEnd; const due = calc.due;
  const graceDays = daysDiff(purchase, due); const today = new Date(); const daysLeft = daysDiff(today, due);
  let prog = 0;
  if(graceDays > 0){ const elapsed = daysDiff(purchase, today); prog = Math.round(Math.max(0, Math.min(100, (elapsed / graceDays) * 100))); } else { prog = 100; }
  let html = '<div><strong>Purchase:</strong> ' + fmt(purchase) + '</div>';
  html += '<div><strong>Cycle ends:</strong> ' + fmt(cycleEnd) + '</div>';
  html += '<div><strong>Payment due:</strong> ' + fmt(due) + '</div>';
  html += '<div><strong>Grace period:</strong> ' + graceDays + ' days</div>';
  if(daysLeft >= 0){ html += '<div><strong>Grace window closes in:</strong> ' + daysLeft + ' days</div>'; html += '<div class=\"small\" style=\"margin-top:6px;color:var(--muted)\">Progress</div>'; } else { html += '<div style=\"color:red\"><strong>Grace window expired</strong></div>'; }
  document.getElementById('analysisSummary').innerHTML = html;
  const progEl = document.getElementById('analysisProgress'); if(progEl){ const color = (theme==='dark')? 'linear-gradient(90deg,#00a3ff,#9b59b6)' : 'linear-gradient(90deg,var(--cib-blue),var(--cib-orange))'; progEl.style.background = color; progEl.style.width = prog + '%'; }
  
  // Enhanced analysis
  updateEnhancedGraceAnalysis();
  renderScenarios();
  buildGraceWeekChart(due);
}

/* Data export/import/settings */
function exportData(){ 
  const data={ 
    banks:load(BANKS_KEY), 
    tx:load(TX_KEY), 
    scenarios: load(SCENARIOS_KEY),
    theme:theme 
  }; 
  const blob=new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}); 
  const url=URL.createObjectURL(blob); 
  const a=document.createElement('a'); 
  a.href=url; 
  a.download='gracewise_export.json'; 
  document.body.appendChild(a); 
  a.click(); 
  a.remove(); 
  URL.revokeObjectURL(url); 
}

function importData(e){ 
  const file=e.target.files[0]; 
  if(!file) return; 
  const reader=new FileReader(); 
  reader.onload=function(){ 
    try{ 
      const data=JSON.parse(reader.result); 
      if(data.banks) localStorage.setItem(BANKS_KEY,JSON.stringify(data.banks)); 
      if(data.tx) localStorage.setItem(TX_KEY,JSON.stringify(data.tx)); 
      if(data.scenarios) localStorage.setItem(SCENARIOS_KEY,JSON.stringify(data.scenarios));
      if(data.theme) { theme=data.theme; applyTheme(); } 
      renderBanks(); 
      renderTxCards(); 
      renderScenarios();
      alert('Imported'); 
    }catch(err){ 
      alert('Invalid JSON'); 
    } 
  }; 
  reader.readAsText(file); 
}

function clearAllData(){ 
  if(!confirm('Clear all saved banks, transactions, and scenarios?')) return; 
  localStorage.removeItem(BANKS_KEY); 
  localStorage.removeItem(TX_KEY); 
  localStorage.removeItem(SCENARIOS_KEY);
  renderBanks(); 
  renderTxCards(); 
  renderScenarios();
  alert('Cleared'); 
}

function restoreDefaults(){ 
  if(!confirm('Restore defaults and clear data?')) return; 
  localStorage.clear(); 
  theme='cib'; 
  applyTheme(); 
  renderBanks(); 
  renderTxCards(); 
  renderScenarios();
  alert('Restored'); 
}
</script>
</body>
</html>
