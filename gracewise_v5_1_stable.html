<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GraceWise v5.1 Stable</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{--cib-blue:#005BAC;--cib-orange:#F37021;--cib-bg:#F8F9FB;--cib-text:#1B1B1B;--okx-bg:#0b0f14;--okx-text:#e6eef3;--muted:#76808a}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--cib-bg);color:var(--cib-text)}
.container{max-width:1100px;margin:12px auto;padding:8px}
.header{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;background:linear-gradient(90deg,var(--cib-blue),var(--cib-orange));color:white;gap:12px}
.logo-wrap{width:44px;height:44px;border-radius:8px;background:rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:18px}
.title{font-weight:700;font-size:16px}
.header-controls{display:flex;gap:8px;align-items:center}
.icon-btn{background:rgba(255,255,255,0.12);border:0;color:white;padding:8px 10px;border-radius:8px;cursor:pointer}
.main{display:flex;gap:12px;margin-top:12px}
.left{width:360px}
.right{flex:1}
.panel{background:white;border-radius:10px;padding:12px;box-shadow:0 6px 20px rgba(10,20,30,0.04);margin-bottom:12px}
.dark .panel{background:#0f1419;color:var(--okx-text)}
.tab-section{display:none}
.tab-section.active{display:block}
label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
input,select,textarea,button{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ee;background:white;font-size:14px}
.dark input,.dark select,.dark textarea{background:#0b0f14;border:1px solid rgba(255,255,255,0.04);color:var(--okx-text)}
.bank-item, .tx-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;border:1px solid #eef2f5;margin-top:8px;background:transparent}
.bottom-nav{position:fixed;left:0;right:0;bottom:0;height:64px;background:rgba(255,255,255,0.98);display:flex;justify-content:space-around;align-items:center;border-top:1px solid #e6e9ee;z-index:50}
.bottom-nav .nav-item{flex:1;display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;padding:10px 6px;color:var(--muted);font-weight:600}
.bottom-nav .nav-item.active{color:var(--cib-blue);background:linear-gradient(90deg, rgba(0,90,180,0.06), rgba(243,112,33,0.03));}
.material-icons-outlined{font-size:20px}
@media(max-width:900px){.main{flex-direction:column}.left{width:100%}.bottom-nav{height:72px}}
.small{font-size:13px;color:var(--muted)}
#splash{position:fixed;inset:0;background:linear-gradient(90deg,var(--cib-blue),var(--cib-orange));display:flex;align-items:center;justify-content:center;flex-direction:column;color:white;opacity:1;transition:opacity 0.5s ease;z-index:9999}
#splash.hidden{opacity:0;pointer-events:none}
.splash-box{width:140px;height:140px;border-radius:18px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.06);font-weight:800;font-size:44px}
.splash-sub{margin-top:12px;opacity:0.95;font-size:14px}
#errorBar{position:fixed;top:0;left:0;right:0;background:#ff4d4d;color:white;padding:8px;display:none;z-index:10001;text-align:center;font-weight:700}
.progress-wrap{width:100%;height:10px;background:#e6e6e6;border-radius:6px;margin-top:8px;overflow:hidden}
.progress-bar{height:100%;border-radius:6px;transition:width 0.3s ease}
.dark .progress-wrap{background:#1a1f27}
.dark .progress-bar{background:linear-gradient(90deg,#00a3ff,#9b59b6)}
</style>
</head>
<body>
<div id="errorBar"></div>
<div id="splash">
  <div class="splash-box">GW</div>
  <div class="splash-sub">GraceWise — Smart Credit Dashboard</div>
</div>

<div id="app" class="container" style="display:none">
  <div class="header" id="header">
    <div class="brand">
      <div class="logo-wrap" id="logo">GW</div>
      <div>
        <div class="title">GraceWise</div>
        <div class="subtitle">Smart Credit Dashboard</div>
      </div>
    </div>
    <div class="header-controls">
      <button class="icon-btn" id="themeToggle"><span class="material-icons-outlined">brightness_6</span>Theme</button>
      <button class="icon-btn" id="exportBtn"><span class="material-icons-outlined">save_alt</span>Export</button>
    </div>
  </div>

  <div class="main">
    <div class="left">
      <div class="panel">
        <div id="tabCards" class="tab-section">
          <h3>Cards / Banks</h3>
          <div class="small">Create or edit cards. Annual rate & default interest method.</div>
          <label>Card name<input id="bankName" placeholder="e.g. CIB Mastercard"></label>
          <label>Cycle End (day)<input id="bankEnd" type="date"></label>
          <label>Due Date (day)<input id="bankDue" type="date"></label>
          <label>Annual Rate (%)<input id="bankRate" type="number" step="0.01" placeholder="e.g. 24"></label>
          <label>Default Interest Method<select id="bankMethod"><option value="simple">Simple</option><option value="compound">Compound (daily)</option></select></label>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="saveBank">Save / Update</button>
            <button id="newBank" class="small-btn">New</button>
          </div>
          <div id="banksList"></div>
        </div>

        <div id="tabSettings" class="tab-section">
          <h3>Settings</h3>
          <div class="small">Theme, export/import, reset data, and app info.</div>
          <label>Theme<select id="settingsTheme"><option value="cib">CIB Light</option><option value="dark">Dark OKX</option></select></label>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="exportAll" class="small-btn">Export JSON</button>
            <label class="small-btn" style="display:inline-block;cursor:pointer">Import JSON <input id="importFile" type="file" accept="application/json" style="display:none"></label>
          </div>
          <div style="margin-top:8px">
            <button id="clearData" class="small-btn">Clear All Data</button>
            <button id="restoreDefaults" class="small-btn">Restore Defaults</button>
          </div>
          <div class="footer">GraceWise v5.1 © 2025 — Stable build</div>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="panel">
        <div id="tabTx" class="tab-section active">
          <h3>Transactions</h3>
          <div class="small">Register purchases, track due dates and interest.</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <select id="txCard"></select>
            <input id="txDate" type="date" style="width:150px">
            <input id="txAmount" type="number" placeholder="EGP" style="width:120px">
          </div>
          <label>Description<input id="txDesc" placeholder="Merchant or note"></label>
          <label>Interest method override<select id="txMethod"><option value="">Use card default</option><option value="simple">Simple</option><option value="compound">Compound</option></select></label>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="addTx">Add Transaction</button>
            <button id="clearTx" class="small-btn">Clear</button>
          </div>
          <div id="txPanel" style="margin-top:12px;display:none">
            <h4>Transactions list</h4>
            <div id="txList"></div>
          </div>
        </div>

        <div id="tabGrace" class="tab-section">
          <h3>Grace Analysis</h3>
          <div class="small">Choose a card and a purchase date to calculate the grace period. This simulates the repeating monthly cycle.</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <select id="analysisCard" style="flex:1"></select>
            <input id="analysisDate" type="date" style="width:180px">
            <button id="analysisNow" class="small-btn" style="width:120px">Calculate</button>
          </div>
          <div id="analysisBox" style="margin-top:12px;border-radius:10px;padding:12px;background:linear-gradient(180deg,rgba(0,0,0,0.03),transparent)">
            <div id="analysisSummary" style="font-size:14px"></div>
            <div class="progress-wrap" style="margin-top:10px"><div id="analysisProgress" class="progress-bar" style="width:0%"></div></div>
          </div>
          <div style="margin-top:16px">
            <canvas id="analysisWeekChart"></canvas>
          </div>
        </div>

        <div id="tabInsights" class="tab-section">
          <h3>Insights</h3>
          <div class="small">Aggregated totals, overdue distribution, and per-card charts.</div>
          <div id="insightsContent"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="bottom-nav" id="bottomNav">
    <div class="nav-item" data-target="tabCards"><span class="material-icons-outlined">account_balance</span><span>Cards</span></div>
    <div class="nav-item" data-target="tabTx"><span class="material-icons-outlined">credit_card</span><span>Transactions</span></div>
    <div class="nav-item active" data-target="tabGrace"><span class="material-icons-outlined">show_chart</span><span>Grace</span></div>
    <div class="nav-item" data-target="tabInsights"><span class="material-icons-outlined">insights</span><span>Insights</span></div>
    <div class="nav-item" data-target="tabSettings"><span class="material-icons-outlined">settings</span><span>Settings</span></div>
  </div>
</div>

<script>
/* Keys */
const BANKS_KEY='gw_v4_banks', TX_KEY='gw_v4_tx', THEME_KEY='gw_v4_theme', LAST_TAB='gw_v4_last_tab';

/* Utils */
function uid(){return Math.random().toString(36).slice(2,9)}
function load(k){try{return JSON.parse(localStorage.getItem(k)||'[]')}catch{return[]}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function setVal(k,v){localStorage.setItem(k,v)}
function getVal(k){return localStorage.getItem(k)}
function fmt(d){return d?new Date(d).toLocaleDateString():'-'}
function parseDate(v){return v?new Date(v+'T00:00:00'):null}
function daysDiff(a,b){return Math.round((b-a)/(1000*60*60*24))}
function toEGP(n){return 'EGP '+Number(n||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}

/* interest */
function simpleInterest(amount,annual,days){const daily=(annual/100)/365;return amount*daily*days}
function compoundInterest(amount,annual,days){const daily=(annual/100)/365;return amount*(Math.pow(1+daily,days)-1)}

/* Theme */
let theme = getVal(THEME_KEY) || 'cib';
function applyTheme(){ if(theme==='dark'){document.documentElement.classList.add('dark'); document.body.style.background='linear-gradient(180deg,#02040a,#071018)'; document.querySelector('.header').style.background='linear-gradient(90deg,#071025,#00122b)'; } else { document.documentElement.classList.remove('dark'); document.body.style.background='var(--cib-bg)'; document.querySelector('.header').style.background='linear-gradient(90deg,var(--cib-blue),var(--cib-orange))'; } setVal(THEME_KEY,theme); if(document.getElementById('settingsTheme')) document.getElementById('settingsTheme').value=theme; }

/* Safe-run wrapper */
function runSafe(fn){ try{ fn(); }catch(err){ reportError(err); console.error(err); } }
function reportError(e){ const bar=document.getElementById('errorBar'); if(!bar) return; bar.style.display='block'; bar.textContent = '⚠️ '+(e && e.message ? e.message : String(e)); }

/* Demo data on first run */
function seedDemoData(){
  if(localStorage.getItem('gw_demo_seeded')) return;
  const demoBank = { id: 'demo1', name: 'CIB Demo', start: new Date().toISOString().slice(0,10), end: new Date().toISOString().slice(0,10), due: (()=>{ const d=new Date(); d.setMonth(d.getMonth()+1); d.setDate(15); return d.toISOString().slice(0,10); })(), rate:24, method:'compound' };
  const demoTx = [{ id:'t1', bankId:'demo1', date: new Date().toISOString().slice(0,10), amount:1200, desc:'Demo purchase', methodOverride:null }];
  localStorage.setItem(BANKS_KEY, JSON.stringify([demoBank]));
  localStorage.setItem(TX_KEY, JSON.stringify(demoTx));
  localStorage.setItem('gw_demo_seeded','1');
}

/* Init */
function init(){
  runSafe(()=>{ seedDemoData(); renderBanks(); renderTxCards(); populateAnalysisCards(); bindUI(); applyTheme(); const last=getVal(LAST_TAB)||'tabGrace'; openTab(last); document.querySelectorAll('.bottom-nav .nav-item').forEach(n=>{ n.classList.toggle('active', n.dataset.target===last); }); if(load(TX_KEY).length) document.getElementById('txPanel').style.display='block'; });
}

/* Bind UI */
function bindUI(){
  runSafe(()=>{
    document.getElementById('themeToggle').onclick = ()=>{ theme = (theme==='cib'?'dark':'cib'); applyTheme(); };
    document.getElementById('exportBtn').onclick = exportData;
    document.getElementById('saveBank').onclick = saveBank;
    document.getElementById('newBank').onclick = ()=>{ document.getElementById('bankName').value=''; document.getElementById('bankStart').value=''; document.getElementById('bankEnd').value=''; document.getElementById('bankDue').value=''; document.getElementById('bankRate').value=''; };
    document.getElementById('addTx').onclick = addTransaction;
    document.getElementById('clearTx').onclick = ()=>{ document.getElementById('txDate').value=''; document.getElementById('txAmount').value=''; document.getElementById('txDesc').value=''; document.getElementById('txMethod').value=''; };
    document.querySelectorAll('.bottom-nav .nav-item').forEach(n=>n.addEventListener('click', ()=>{ openTab(n.dataset.target); document.querySelectorAll('.bottom-nav .nav-item').forEach(x=>x.classList.remove('active')); n.classList.add('active'); setVal(LAST_TAB,n.dataset.target); }));
    const settingsTheme = document.getElementById('settingsTheme'); if(settingsTheme) settingsTheme.addEventListener('change', (e)=>{ theme = e.target.value; applyTheme(); });
    const exportAll = document.getElementById('exportAll'); if(exportAll) exportAll.addEventListener('click', exportData);
    const importFile = document.getElementById('importFile'); if(importFile) importFile.addEventListener('change', importData);
    const clearDataBtn = document.getElementById('clearData'); if(clearDataBtn) clearDataBtn.addEventListener('click', clearAllData);
    const restoreDefaultsBtn = document.getElementById('restoreDefaults'); if(restoreDefaultsBtn) restoreDefaultsBtn.addEventListener('click', restoreDefaults);
    const analysisNow = document.getElementById('analysisNow'); if(analysisNow) analysisNow.addEventListener('click', updateGraceAnalysis);
    const analysisCard = document.getElementById('analysisCard'); if(analysisCard) analysisCard.addEventListener('change', updateGraceAnalysis);
    const analysisDate = document.getElementById('analysisDate'); if(analysisDate) analysisDate.addEventListener('change', updateGraceAnalysis);
  });
}

/* Tabs and rendering */
function openTab(id){ runSafe(()=>{ document.querySelectorAll('.tab-section').forEach(s=>s.classList.remove('active')); const el=document.getElementById(id); if(el) el.classList.add('active'); if(id==='tabTx' && load(TX_KEY).length>0) document.getElementById('txPanel').style.display='block'; else { const txPanel=document.getElementById('txPanel'); if(txPanel) txPanel.style.display='none'; } setVal(LAST_TAB,id); }); }

function renderBanks(){ runSafe(()=>{ const banks=load(BANKS_KEY); const list=document.getElementById('banksList'); const txCard=document.getElementById('txCard'); list.innerHTML=''; if(txCard) txCard.innerHTML=''; if(!banks.length){ list.innerHTML='<div class="small">No cards yet.</div>'; if(txCard) txCard.innerHTML='<option value=\"\">No card</option>'; return; } banks.forEach(b=>{ const div=document.createElement('div'); div.className='bank-item'; div.innerHTML = `<div><strong>${b.name}</strong><div class='small'>Due ${fmt(b.due)} • ${b.rate}% • ${b.method}</div></div><div><button class='small-btn' data-id='${b.id}'>Open</button></div>`; div.querySelector('button').onclick = ()=>{ openTab('tabCards'); document.getElementById('bankName').value=b.name; document.getElementById('bankStart').value=b.start; document.getElementById('bankEnd').value=b.end; document.getElementById('bankDue').value=b.due; document.getElementById('bankRate').value=b.rate; document.getElementById('bankMethod').value=b.method; }; list.appendChild(div); if(txCard){ const opt=document.createElement('option'); opt.value=b.id; opt.textContent=b.name; txCard.appendChild(opt); } }); }); }

function renderTxCards(){ runSafe(()=>{ const banks=load(BANKS_KEY); const sel=document.getElementById('txCard'); if(!sel) return; sel.innerHTML=''; if(!banks.length){ sel.innerHTML='<option value=\"\">No card</option>'; return;} banks.forEach(b=>{ const opt=document.createElement('option'); opt.value=b.id; opt.textContent=b.name; sel.appendChild(opt); }); }); }

/* Save bank */
function saveBank(){ runSafe(()=>{ const name=document.getElementById('bankName').value.trim(); const start=document.getElementById('bankStart').value; const end=document.getElementById('bankEnd').value; const due=document.getElementById('bankDue').value; const rate=parseFloat(document.getElementById('bankRate').value); const method=document.getElementById('bankMethod').value; if(!name||!start||!end||!due||isNaN(rate)){ alert('Please fill all card fields'); return; } const banks = load(BANKS_KEY); const existing = banks.find(x=>x.name.toLowerCase()===name.toLowerCase()); if(existing){ existing.start=start; existing.end=end; existing.due=due; existing.rate=rate; existing.method=method; } else { banks.push({id:uid(),name,start,end,due,rate,method}); } save(BANKS_KEY,banks); renderBanks(); alert('Saved'); document.getElementById('bankName').value=''; renderTxCards(); }); }

/* Transactions */
function addTransaction(){ runSafe(()=>{ const bankId=document.getElementById('txCard').value; const date=document.getElementById('txDate').value; const amt=parseFloat(document.getElementById('txAmount').value); const desc=document.getElementById('txDesc')?document.getElementById('txDesc').value.trim():''; const method=document.getElementById('txMethod')?document.getElementById('txMethod').value:null; if(!bankId||!date||isNaN(amt)||amt<=0){ alert('Fill transaction fields'); return; } const banks=load(BANKS_KEY); const b=banks.find(x=>x.id===bankId); if(!b){ alert('Card not found'); return; } const txs=load(TX_KEY); txs.push({id:uid(),bankId,date,amount:Math.round(amt*100)/100,desc,methodOverride:method}); save(TX_KEY,txs); alert('Transaction added'); buildTxPanel(b); }); }

function buildTxPanel(bank){ runSafe(()=>{ const txs = load(TX_KEY).filter(t=>t.bankId===bank.id).sort((a,b)=>new Date(a.date)-new Date(b.date)); const txList=document.getElementById('txList'); if(!txList) return; txList.innerHTML=''; let sumP=0,sumI=0; const today=new Date(); txs.forEach(tx=>{ const purchase=parseDate(tx.date); const calc=calculateDueForCycle(bank,purchase); const due=calc.due; const grace=daysDiff(purchase,due); const overdue=Math.max(0,daysDiff(due,today)); const method=tx.methodOverride||bank.method; let interest=0; let total=tx.amount; if(overdue>0){ if(method==='compound') interest=compoundInterest(tx.amount,bank.rate,overdue); else interest=simpleInterest(tx.amount,bank.rate,overdue); total=tx.amount+interest; } sumP+=tx.amount; sumI+=interest; const div=document.createElement('div'); div.className='tx-row'; div.innerHTML=`<div><strong>${tx.desc||'Purchase'}</strong><div class="small">${fmt(purchase)} • Due ${fmt(due)} • Grace ${grace}d</div></div><div style="text-align:right"><div style="font-weight:700">${toEGP(tx.amount)}</div><div class="small">Interest: ${toEGP(interest)}</div><div class="small">Total: ${toEGP(total)}</div></div>`; txList.appendChild(div); }); }); }

/* Grace Analysis */
let analysisWeekChart=null;
function populateAnalysisCards(){ runSafe(()=>{ const sel=document.getElementById('analysisCard'); if(!sel) return; sel.innerHTML=''; const banks=load(BANKS_KEY); if(!banks.length){ sel.innerHTML='<option value=\"\">No cards</option>'; return; } banks.forEach(b=>{ const o=document.createElement('option'); o.value=b.id; o.textContent=b.name; sel.appendChild(o); }); const last=getVal('gw_analysis_card')|| (banks[0]&&banks[0].id); if(last) sel.value=last; }); }

function calculateDueForCycle(bank,purchaseDate){ const endDay=new Date(bank.end).getDate(); const dueDay=new Date(bank.due).getDate(); const purchase=new Date(purchaseDate.getFullYear(),purchaseDate.getMonth(),purchaseDate.getDate()); let cycleEndMonth=purchase.getMonth(); let cycleEndYear=purchase.getFullYear(); if(purchase.getDate()>endDay){ cycleEndMonth++; if(cycleEndMonth>11){ cycleEndMonth=0; cycleEndYear++; } } const cycleEnd=new Date(cycleEndYear,cycleEndMonth,endDay); let dueMonth=cycleEnd.getMonth()+1; let dueYear=cycleEnd.getFullYear(); if(dueMonth>11){ dueMonth=0; dueYear++; } const daysInMonth=new Date(dueYear,dueMonth+1,0).getDate(); const dueDayAdjusted=Math.min(dueDay,daysInMonth); const due=new Date(dueYear,dueMonth,dueDayAdjusted); return {cycleEnd, due}; }

function updateGraceAnalysis(){ runSafe(()=>{ const sel=document.getElementById('analysisCard'); const banks=load(BANKS_KEY); if(!banks || !banks.length){ document.getElementById('analysisSummary').innerHTML='<div class=\"small\">No cards saved. Add a card in Cards / Banks.</div>'; return; } const bank=banks.find(b=>b.id===sel.value) || banks[0]; setVal('gw_analysis_card', bank.id); const purchaseInput=document.getElementById('analysisDate').value; if(!purchaseInput){ document.getElementById('analysisSummary').innerHTML='<div class=\"small\">Select a purchase date.</div>'; return; } const purchase=new Date(purchaseInput+'T00:00:00'); const calc=calculateDueForCycle(bank,purchase); const cycleEnd=calc.cycleEnd; const due=calc.due; const graceDays=daysDiff(purchase,due); const today=new Date(); const daysLeft=daysDiff(today,due); let prog=0; if(graceDays>0){ const elapsed=daysDiff(purchase,today); prog=Math.round(Math.max(0,Math.min(100,(elapsed/graceDays)*100))); } else prog=100; let html='<div><strong>Purchase:</strong> '+fmt(purchase)+'</div>'; html+='<div><strong>Cycle ends:</strong> '+fmt(cycleEnd)+'</div>'; html+='<div><strong>Payment due:</strong> '+fmt(due)+'</div>'; html+='<div><strong>Grace period:</strong> '+graceDays+' days</div>'; if(daysLeft>=0){ html+='<div><strong>Grace window closes in:</strong> '+daysLeft+' days</div>'; html+='<div class=\"small\" style=\"margin-top:6px;color:var(--muted)\">Progress</div>'; } else { html+='<div style=\"color:red\"><strong>Grace window expired</strong></div>'; } document.getElementById('analysisSummary').innerHTML=html; const progEl=document.getElementById('analysisProgress'); if(progEl){ const color=(theme==='dark')? 'linear-gradient(90deg,#00a3ff,#9b59b6)' : 'linear-gradient(90deg,var(--cib-blue),var(--cib-orange))'; progEl.style.background=color; progEl.style.width=prog+'%'; } buildGraceWeekChart(due); }); }

/* Charts */
function buildGraceWeekChart(due){ runSafe(()=>{ const canvas=document.getElementById('analysisWeekChart'); if(!canvas) return; const ctx=canvas.getContext('2d'); const today=new Date(); const start=new Date(today); start.setDate(today.getDate()-today.getDay()); start.setHours(0,0,0,0); const labels=[], data=[], bg=[]; for(let i=0;i<7;i++){ const d=new Date(start); d.setDate(start.getDate()+i); labels.push(d.toLocaleDateString('en-US',{weekday:'short'})); const gd=daysDiff(d,due); data.push(gd); if(theme==='dark'){ bg.push(gd>=30? '#00a3ff': (gd>=15? '#9b59b6':'#ff6b6b')); } else { bg.push(gd>=30? '#005BAC': (gd>=15? '#F37021':'#ff6b6b')); } } if(analysisWeekChart) analysisWeekChart.destroy(); analysisWeekChart=new Chart(ctx,{ type:'bar', data:{ labels:labels, datasets:[{ label:'Grace days', data:data, backgroundColor:bg }] }, options:{ responsive:true, plugins:{ legend:{ display:false }, title:{ display:true, text:\"This Week's Grace Overview\" } }, scales:{ y:{ beginAtZero:true } } } }); }); }

/* Export / import / settings */
function exportData(){ runSafe(()=>{ const data={ banks:load(BANKS_KEY), tx:load(TX_KEY), theme:theme }; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='gracewise_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }); }
function importData(e){ runSafe(()=>{ const file=e.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=function(){ try{ const data=JSON.parse(reader.result); if(data.banks) localStorage.setItem(BANKS_KEY,JSON.stringify(data.banks)); if(data.tx) localStorage.setItem(TX_KEY,JSON.stringify(data.tx)); if(data.theme){ theme=data.theme; applyTheme(); } renderBanks(); renderTxCards(); alert('Imported'); }catch(err){ alert('Invalid JSON'); } }; reader.readAsText(file); }); }
function clearAllData(){ if(!confirm('Clear all saved banks and transactions?')) return; localStorage.removeItem(BANKS_KEY); localStorage.removeItem(TX_KEY); renderBanks(); renderTxCards(); alert('Cleared'); }
function restoreDefaults(){ if(!confirm('Restore defaults and clear data?')) return; localStorage.clear(); theme='cib'; applyTheme(); renderBanks(); renderTxCards(); alert('Restored'); }

/* Safe boot: hide splash then run init, guaranteed */
document.addEventListener('DOMContentLoaded', ()=>{
  // always hide splash after 1s with fade
  setTimeout(()=>{ const splash=document.getElementById('splash'); if(splash){ splash.classList.add('hidden'); setTimeout(()=>{ splash.style.display='none'; document.getElementById('app').style.display='block'; },500); } },1000);
  // run init safely
  setTimeout(()=>{ try{ init(); }catch(err){ reportError(err); } },1100);
});

</script>
</body>
</html>