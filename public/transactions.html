<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GraceWise â€” Transactions</title>
  <link rel="stylesheet" href="theme.css">
  <style>
    /* Inline adjustments to match theme */
  /* === Layout and Table Size Alignment Fix === */
.container {
  max-width: 100%;
  padding: 12px 10px;
  margin: 0 auto;
  box-sizing: border-box;
}

.panel {
  width: 100%;
  max-width: 950px;
  margin: 0 auto 14px;
  padding: 14px;
  border-radius: 10px;
  box-sizing: border-box;
}

table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

th, td {
  padding: 10px 8px;
  word-wrap: break-word;
  text-align: left;
}

@media (max-width: 768px) {
  th, td { font-size: 12.5px; }
  .panel { padding: 10px; }
  .container { padding: 8px; }
}  </style>
</head>
<body>
  <div class="header" style="display:flex;align-items:center;justify-content:space-between;padding:14px;background:linear-gradient(90deg,#005BAC,#F37021);color:#fff">
    <div style="display:flex;gap:12px;align-items:center">
      <div class="logo" style="font-weight:800;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.06)">GW</div>
      <div>
        <div style="font-weight:700;font-size:18px">GraceWise</div>
        <div class="small" style="color:rgba(255,255,255,0.9)">Transactions</div>
      </div>
    </div>
    <div>
      <button onclick="location.href='/cards'" style="background:transparent;border:1px solid rgba(255,255,255,0.12);color:#fff;padding:8px 12px;border-radius:8px">Cards</button>
    </div>
  </div>

  <div class="container">
    <!-- Transaction Form -->
    <div class="panel" id="txFormPanel">
      <h3>Record Transaction</h3>
      <div class="small">Select card, date and amount. Transactions will be used for grace analysis and overdue calculations.</div>

      <label>Card / Bank
        <select id="txCard"></select>
      </label>

      <div class="row" style="margin-top:6px">
        <div class="col">
          <label>Purchase Date<input id="txDate" type="date"></label>
        </div>
        <div class="col">
          <label>Amount (EGP)<input id="txAmount" type="number" step="0.01" min="0.01" placeholder="0.00"></label>
        </div>
      </div>

      <label>Description (optional)<input id="txDesc" type="text" placeholder="e.g. supermarket"></label>

      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="saveTxBtn">Save Transaction</button>
        <button id="cancelEditBtn" style="background:#f3f4f6">Cancel</button>
        <button id="downloadTxBtn" style="margin-left:auto;background:#fff;border:1px solid #e6eef6">Export</button>
      </div>
    </div>

    <!-- Analytics Table -->
    <div class="panel" id="txPanel">
      <h3>Transactions & Grace Analysis</h3>
      <div class="small">Each transaction shows calculated due date, grace days, overdue interest and the total due (if any).</div>

      <table id="txTable" aria-label="Transactions table">
        <thead>
          <tr>
            <th>Card</th>
            <th>Purchase</th>
            <th>Amount</th>
            <th>Due</th>
            <th>Status</th>
            <th>Interest</th>
            <th>Total Due</th>
            <th style="width:120px;text-align:center">Actions</th>
          </tr>
        </thead>
        <tbody id="txTableBody">
          <tr><td colspan="8" class="tx-empty">Loading transactions...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item" onclick="location.href='/cards'">Cards</div>
    <div class="nav-item active" onclick="location.href='/transactions'">Transactions</div>
    <div class="nav-item" onclick="location.href='/grace'">Grace</div>
    <div class="nav-item" onclick="location.href='/settings'">Settings</div>
  </div>

  <script src="core.js"></script>
  <script>
    // transactions.html v5.8.4 FULL â€” Recording + Analytics (client-side)
    (function(){
      // Helpers from core.js are expected:
      // load, save, uid, BANKS_KEY, TX_KEY, markInvalid, clearInvalid, scrollToInvalid, syncToServer, fmt, toEGP (some provided below for safety)
      function fmtLocal(d){ return d ? new Date(d).toLocaleDateString() : '-'; }
      function toEGPLocal(n){ return 'EGP ' + Number(n||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }

      const cardSel = document.getElementById('txCard');
      const dateEl = document.getElementById('txDate');
      const amountEl = document.getElementById('txAmount');
      const descEl = document.getElementById('txDesc');
      const saveBtn = document.getElementById('saveTxBtn');
      const cancelBtn = document.getElementById('cancelEditBtn');
      const downloadBtn = document.getElementById('downloadTxBtn');
      const tableBody = document.getElementById('txTableBody');

      let editingId = null;

      function loadCardsToDropdown(){
        const banks = load(BANKS_KEY());
        cardSel.innerHTML = '';
        if(!banks.length){
          const o=document.createElement('option'); o.value=''; o.textContent='-- No saved cards --'; cardSel.appendChild(o); return;
        }
        const placeholder = document.createElement('option'); placeholder.value=''; placeholder.textContent='-- Select card --'; cardSel.appendChild(placeholder);
        banks.forEach(b=>{
          const o=document.createElement('option'); o.value=b.id; o.textContent=b.name; cardSel.appendChild(o);
        });
      }

      function validateTxForm(){
        // clear previous
        [cardSel, dateEl, amountEl].forEach(el=>clearInvalid(el));
        let firstInvalid = null;
        if(!cardSel.value){ markInvalid(cardSel,'Choose a card'); firstInvalid = firstInvalid||cardSel; }
        if(!dateEl.value){ markInvalid(dateEl,'Pick a date'); firstInvalid = firstInvalid||dateEl; }
        const amt = parseFloat(amountEl.value||'0'); if(isNaN(amt) || amt<=0){ markInvalid(amountEl,'Amount must be > 0'); firstInvalid = firstInvalid||amountEl; }
        if(firstInvalid){ scrollToInvalid(firstInvalid); return false; }
        return true;
      }

      function getTxs(){ return load(TX_KEY()); }
      function getCards(){ return load(BANKS_KEY()); }

      function computeTxDetails(tx){
        // tx: { id, bankId (cardId), date, amount, desc }
        const card = getCards().find(c=>c.id===tx.bankId);
        if(!card){
          return { tx, cardName:'[no card]', dueDate:null, graceDays:0, status:'No card', color:'#888', interest:0, totalDue:tx.amount||0, progress:0 };
        }

        const cycleEnd = parseInt(card.end || 21);
        const dueDay = parseInt(card.due || 15);
        const annual = parseFloat(card.rate || 0);
        const daily = parseFloat(card.daily || (annual/365));
        const fine = parseFloat(card.fine || 0);
        const amount = parseFloat(tx.amount||0);

        const purchase = new Date(tx.date || tx.purchaseDate || tx.purchase || new Date());
        const pDay = purchase.getDate();
        const pMonth = purchase.getMonth();
        const pYear = purchase.getFullYear();

        let cycleMonth = pMonth;
        let cycleYear = pYear;
        if (pDay > cycleEnd){
          cycleMonth += 1;
          if(cycleMonth > 11){ cycleMonth = 0; cycleYear += 1; }
        }

        let dueMonth = cycleMonth + 1;
        let dueYear = cycleYear;
        if(dueMonth > 11){ dueMonth = 0; dueYear += 1; }
        const dueDate = new Date(dueYear, dueMonth, dueDay);

        const graceDays = Math.round((dueDate - purchase) / (1000*60*60*24));
        const today = new Date();
        const daysLeft = Math.round((dueDate - today)/(1000*60*60*24));

        let status = '', color = '', interest = 0, totalDue = amount;
        if(daysLeft > 0){
          status = `ðŸŸ¢ In grace (${daysLeft} days left)`;
          color = '#059669';
        } else if(daysLeft === 0){
          status = 'ðŸŸ¡ Due today';
          color = '#f59e0b';
        } else {
          const overdueDays = Math.abs(daysLeft);
          interest = amount * (daily/100) * overdueDays;
          totalDue = amount + interest + fine;
          status = `ðŸ”´ Overdue by ${overdueDays} days`;
          color = '#dc2626';
        }

        const progress = graceDays>0 ? Math.min(Math.round(((graceDays - daysLeft)/graceDays)*100),100) : 100;

        return {
          txId: tx.id,
          cardName: card.name,
          purchase,
          amount,
          dueDate,
          graceDays,
          daysLeft,
          status,
          color,
          interest,
          totalDue,
          progress,
          desc: tx.desc || ''
        };
      }

      function renderTable(){
        const txs = getTxs();
        tableBody.innerHTML = '';
        if(!txs.length){
          tableBody.innerHTML = '<tr><td colspan="8" class="tx-empty">No transactions found</td></tr>';
          return;
        }
        txs.forEach(t=>{
          const d = computeTxDetails({ id:t.id, bankId:t.bankId, date:t.date || t.purchaseDate || t.purchase, amount:t.amount, desc:t.desc });
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${d.cardName}</td>
            <td>${fmtLocal(d.purchase)}</td>
            <td>${toEGPLocal(d.amount)}</td>
            <td>${fmtLocal(d.dueDate)}</td>
            <td style="color:${d.color};font-weight:700">${d.status}</td>
            <td>${d.interest ? toEGPLocal(d.interest) : '-'}</td>
            <td>${toEGPLocal(d.totalDue)}</td>
            <td style="text-align:center" class="tx-actions">
              <button data-id="${t.id}" class="editBtn">Edit</button>
              <button data-id="${t.id}" class="delBtn" style="background:#fee2e2">Delete</button>
            </td>
          `;
          tableBody.appendChild(tr);

          // progress bar row
          const pr = document.createElement('tr');
          pr.innerHTML = `<td colspan="8"><div class="progress-wrap"><div class="progress" style="width:${d.progress}%;background:linear-gradient(90deg,#005BAC,#F37021)"></div></div></td>`;
          tableBody.appendChild(pr);
        });

        // attach actions
        document.querySelectorAll('.editBtn').forEach(b=>{
          b.addEventListener('click', (ev)=>{
            const id = ev.currentTarget.dataset.id;
            startEdit(id);
          });
        });
        document.querySelectorAll('.delBtn').forEach(b=>{
          b.addEventListener('click', async (ev)=>{
            const id = ev.currentTarget.dataset.id;
            if(!confirm('Delete this transaction?')) return;
            let arr = getTxs().filter(x=>x.id!==id);
            save(TX_KEY(), arr);
            renderTable();
            try{ await syncToServer(); }catch(e){}
          });
        });
      }

      function resetForm(){
        editingId = null;
        cardSel.value = '';
        dateEl.value = '';
        amountEl.value = '';
        descEl.value = '';
        saveBtn.textContent = 'Save Transaction';
      }

      function startEdit(id){
        const arr = getTxs();
        const tx = arr.find(x=>x.id===id);
        if(!tx) return alert('Transaction not found');
        editingId = id;
        cardSel.value = tx.bankId;
        dateEl.value = tx.date || tx.purchaseDate || tx.purchase;
        amountEl.value = tx.amount;
        descEl.value = tx.desc || '';
        saveBtn.textContent = 'Update Transaction';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      async function saveTransaction(){
        if(!validateTxForm()) return;
        const bankId = cardSel.value;
        const date = dateEl.value;
        const amount = parseFloat(amountEl.value);
        const desc = descEl.value.trim();

        let txs = getTxs();
        if(editingId){
          // update
          const idx = txs.findIndex(x=>x.id===editingId);
          if(idx>=0){ txs[idx].bankId = bankId; txs[idx].date = date; txs[idx].amount = amount; txs[idx].desc = desc; }
        } else {
          const obj = { id: uid(), bankId: bankId, date: date, amount: amount, desc: desc };
          txs.push(obj);
        }
        save(TX_KEY(), txs);
        renderTable();
        resetForm();
        try { await syncToServer(); } catch(e){}
      }

      // download/export transactions
      function downloadTxFile(){
        const payload = { transactions: getTxs(), exportedAt: new Date().toISOString() };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download = `gracewise_transactions_${currentUserId()||'guest'}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      // bind events
      saveBtn.addEventListener('click', saveTransaction);
      cancelBtn.addEventListener('click', resetForm);
      downloadBtn.addEventListener('click', downloadTxFile);

      // initial load
      document.addEventListener('DOMContentLoaded', ()=>{
        loadCardsToDropdown();
        renderTable();
      });

      // Also refresh when cards change (e.g. user edits card in cards page then returns)
      window.addEventListener('focus', ()=>{
        loadCardsToDropdown();
        renderTable();
      });

    })();
  </script>
</body>
</html>
