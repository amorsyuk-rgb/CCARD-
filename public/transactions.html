<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transactions ‚Äî GraceWise</title>
  <link rel="stylesheet" href="/theme.css">
  <link rel="stylesheet" href="https://unpkg.com/@tabler/icons-webfont@1.39.1/tabler-icons.min.css">
  <script src="/core.js"></script>
</head>
<body>
  <div class="header">
    <div style="display:flex;gap:12px;align-items:center">
      <div class="logo">GW</div>
      <div>
        <div style="font-weight:700;font-size:18px">GraceWise</div>
        <div class="small">Transactions</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button onclick="location.href='/cards'">Cards</button>
      <button onclick="exportData()">Export</button>
    </div>
  </div>

  <div class="container">
    <div class="panel">
      <h3>Add Transaction</h3>
      <div class="small">Select card, date and amount. Overdue interest & fine are calculated automatically.</div>

      <label>Card
        <select id="txCard"></select>
      </label>

      <label>Date
        <input id="txDate" type="date">
      </label>

      <label>Amount (EGP)
        <input id="txAmount" type="number" step="0.01">
      </label>

      <label>Description
        <input id="txDesc" type="text" placeholder="e.g. supermarket">
      </label>

      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="addBtn">Add Transaction</button>
        <button id="clearBtn">Clear</button>
      </div>
    </div>

    <div id="txPanel" class="panel">
      <h3>Transactions</h3>
      <div id="txList" class="small">No transactions</div>
    </div>
  </div>

  <!-- edit modal -->
  <div id="editModal" class="modal hidden" style="display:none">
    <div class="panel">
      <h3>Edit Transaction</h3>
      <label>Date <input id="editDate" type="date"></label>
      <label>Amount <input id="editAmount" type="number" step="0.01"></label>
      <label>Description <input id="editDesc" type="text"></label>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="saveEdit">Save</button>
        <button id="cancelEdit">Cancel</button>
      </div>
    </div>
  </div>

  <div class="bottom-nav" role="navigation">
    <div class="nav-item" data-path="/cards" onclick="location.href='/cards'"><span class="icon ti ti-credit-card"></span>Cards</div>
    <div class="nav-item active" data-path="/transactions" onclick="location.href='/transactions'"><span class="icon ti ti-wallet"></span>Transactions</div>
    <div class="nav-item" data-path="/grace" onclick="location.href='/grace'"><span class="icon ti ti-chart-bar"></span>Grace</div>
    <div class="nav-item" data-path="/settings" onclick="location.href='/settings'"><span class="icon ti ti-settings"></span>Settings</div>
  </div>

  <script>
    applyTheme(); setActiveNav('/transactions');

    // render card options
    function renderTxCards(){
      const sel = document.getElementById('txCard');
      sel.innerHTML = '';
      const banks = load(BANKS_KEY);
      banks.forEach(b => {
        const o = document.createElement('option'); o.value = b.id; o.textContent = b.name; sel.appendChild(o);
      });
    }

    // render tx list with overdue calc
    function renderTxList(){
      const txs = load(TX_KEY);
      const banks = load(BANKS_KEY);
      const el = document.getElementById('txList');
      el.innerHTML = '';
      if(!txs.length){ el.innerHTML = '<div class="small">No transactions</div>'; return; }
      const today = new Date();
      txs.forEach(t => {
        const b = banks.find(x=>x.id===t.bankId);
        if(!b) return;
        const purchase = parseDate(t.date);
        const calc = calculateDueForCycle(b, purchase);
        const due = calc.due;
        const grace = daysDiff(purchase, due);
        const overdue = Math.max(0, daysDiff(due, today));
        const interest = overdue>0? simpleInterest(t.amount, b.daily, overdue) : 0;
        const fine = overdue>0? b.fine : 0;
        const total = t.amount + interest + fine;

        const row = document.createElement('div');
        row.className = 'tx-row' + (overdue>0? ' overdue' : '');
        row.innerHTML = `
          <div>
            <strong>${t.desc||'Purchase'}</strong>
            <div class="small">${fmt(purchase)} ‚Ä¢ Due ${fmt(due)} ‚Ä¢ Grace ${grace}d</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700">${toEGP(t.amount)}</div>
            <div class="small">Overdue: ${overdue}d</div>
            <div class="small">Interest: ${toEGP(interest)}</div>
            <div class="small">Fine: ${toEGP(fine)}</div>
            <div style="margin-top:6px;font-weight:700">${toEGP(total)}</div>
            <div class="actions" style="margin-top:8px">
              <button class="icon-btn" onclick="editTx('${t.id}')">‚úèÔ∏è</button>
              <button class="icon-btn" onclick="deleteTx('${t.id}')">üóëÔ∏è</button>
            </div>
          </div>`;
        el.appendChild(row);
      });
    }

    // add tx
    document.getElementById('addBtn').addEventListener('click', ()=>{
      const bankId = document.getElementById('txCard').value;
      const date = document.getElementById('txDate').value;
      const amount = parseFloat(document.getElementById('txAmount').value);
      const desc = document.getElementById('txDesc').value.trim();
      if(!bankId || !date || isNaN(amount)){ alert('Fill fields'); return; }
      const txs = load(TX_KEY); txs.push({ id: uid(), bankId, date, amount, desc }); save(TX_KEY, txs); renderTxList();
      document.getElementById('txDate').value=''; document.getElementById('txAmount').value=''; document.getElementById('txDesc').value='';
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      document.getElementById('txDate').value=''; document.getElementById('txAmount').value=''; document.getElementById('txDesc').value='';
    });

    function deleteTx(id){
      if(!confirm('Delete transaction?')) return;
      const txs = load(TX_KEY).filter(t=>t.id!==id);
      save(TX_KEY, txs); renderTxList();
    }

    // edit handling
    let editingId = null;
    const modal = document.getElementById('editModal');
    function editTx(id){
      const txs = load(TX_KEY);
      const t = txs.find(x=>x.id===id);
      if(!t) return;
      editingId = id;
      document.getElementById('editDate').value = t.date;
      document.getElementById('editAmount').value = t.amount;
      document.getElementById('editDesc').value = t.desc || '';
      modal.style.display = 'flex';
      modal.classList.remove('hidden');
    }

    document.getElementById('cancelEdit').addEventListener('click', ()=>{
      editingId = null; modal.style.display = 'none'; modal.classList.add('hidden');
    });

    document.getElementById('saveEdit').addEventListener('click', ()=>{
      const txs = load(TX_KEY);
      const t = txs.find(x=>x.id===editingId);
      if(!t) return;
      t.date = document.getElementById('editDate').value;
      t.amount = parseFloat(document.getElementById('editAmount').value);
      t.desc = document.getElementById('editDesc').value;
      save(TX_KEY, txs);
      editingId = null; modal.style.display = 'none'; modal.classList.add('hidden'); renderTxList();
    });

    document.addEventListener('DOMContentLoaded', ()=>{
      renderTxCards(); renderTxList();
    });
  </script>
</body>
</html>
