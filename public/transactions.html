<!doctype html>
<html lang="en">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Transactions - GraceWise v5.9</title>
<link rel="stylesheet" href="theme.css">
<style>
  body{font-family:Inter,Arial;background:#0f0f0f;color:#e6e6e6;margin:0;padding-bottom:70px}
  .container{max-width:950px;margin:12px auto;padding:12px;box-sizing:border-box}
  .panel{background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;margin-bottom:12px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left}
  th{color:#a8b0b7;font-size:12px;text-transform:uppercase}
  .tx-empty{color:#8a9399;text-align:center;padding:12px}
</style>
</head>
<body>
<header style="background:linear-gradient(90deg,#005BAC,#F37021);padding:14px;color:#fff;text-align:center;font-weight:700">GraceWise â€” Transactions</header>
<div class="container">
  <div class="panel" id="formPanel">
    <h3 style="margin:0 0 8px">Record Transaction</h3>
    <label>Card/Bank<select id="txCard"></select></label>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="txDate" type="date" style="flex:1">
      <input id="txAmount" type="number" step="0.01" min="0.01" placeholder="Amount EGP" style="flex:1">
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="txDesc" placeholder="Description" style="flex:1">
      <button id="saveTxBtn" style="padding:8px 12px;background:linear-gradient(90deg,#005BAC,#F37021);color:#fff;border-radius:8px">Save</button>
    </div>
  </div>

  <div class="panel">
    <h3 style="margin:0 0 8px">Transactions & Analysis</h3>
    <table><thead><tr><th>Card</th><th>Purchase</th><th>Amount</th><th>Due</th><th>Status</th><th>Interest</th><th>Total</th><th>Actions</th></tr></thead>
    <tbody id="txTableBody"><tr><td colspan="8" class="tx-empty">Loading...</td></tr></tbody></table>
  </div>
</div>

<script src="core.js"></script>
<script>
function load(k){ try{ return JSON.parse(localStorage.getItem(k)||'[]')}catch(e){return[]} }
function save(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
function uid(){ return 'tx_' + Math.random().toString(36).slice(2,9); }
const CARD_KEY = (typeof BANKS_KEY === 'function') ? BANKS_KEY() : 'gw_banks_guest';
const TX_KEY_NAME = (typeof TX_KEY === 'function') ? TX_KEY() : 'gw_tx_guest';
function getCards(){ return load(CARD_KEY); }
function getTxs(){ return load(TX_KEY_NAME); }
function populateCards(){ const sel=document.getElementById('txCard'); sel.innerHTML=''; const cards=getCards(); if(!cards.length){ sel.innerHTML='<option value="">-- No cards --</option>'; return; } sel.innerHTML='<option value="">-- Select card --</option>'; cards.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.text=c.name; sel.appendChild(o); }); }
function renderTable(){ const tbody=document.getElementById('txTableBody'); tbody.innerHTML=''; const txs=getTxs()||[]; if(!txs.length){ tbody.innerHTML='<tr><td colspan="8" class="tx-empty">No transactions</td></tr>'; return; } const cards=getCards(); const map={}; cards.forEach(c=>map[c.id]=c); txs.forEach(t=>{ const card = map[t.bankId] || map[t.cardId] || {name:'Unknown', end:21, due:15, rate:0, daily:0, fine:0}; const analysis = computeTransactionAnalysis(t, card, new Date()); const tr=document.createElement('tr'); tr.innerHTML = '<td>'+(card.name||'-')+'</td>' + '<td>'+(analysis.purchase?analysis.purchase.toLocaleDateString():'-')+'</td>' + '<td>'+(t.amount?('EGP '+Number(t.amount).toLocaleString()):'-')+'</td>' + '<td>'+(analysis.dueDate?analysis.dueDate.toLocaleDateString():'-')+'</td>' + '<td style="color:'+analysis.color+';font-weight:700">'+analysis.status+'</td>' + '<td>'+(analysis.interest?('EGP '+analysis.interest.toFixed(2)):'-')+'</td>' + '<td>'+(analysis.totalDue?('EGP '+analysis.totalDue.toFixed(2)):'-')+'</td>' + '<td><button class="edit" data-id="'+t.id+'">Edit</button> <button class="del" data-id="'+t.id+'">Del</button></td>'; tbody.appendChild(tr); }); document.querySelectorAll('.del').forEach(b=> b.addEventListener('click', e=>{ if(!confirm('Delete?')) return; const id=e.currentTarget.dataset.id; const arr=getTxs().filter(x=>x.id!==id); save(TX_KEY_NAME,arr); renderTable(); })); document.querySelectorAll('.edit').forEach(b=> b.addEventListener('click', e=>{ const id=e.currentTarget.dataset.id; const tx=getTxs().find(x=>x.id===id); if(!tx) return; document.getElementById('txCard').value = tx.bankId || tx.cardId || ''; document.getElementById('txDate').value = (tx.date || tx.purchaseDate || tx.purchase) || ''; document.getElementById('txAmount').value = tx.amount || ''; document.getElementById('txDesc').value = tx.desc || ''; localStorage.setItem('__editing_tx', id); })); }
document.getElementById('saveTxBtn').addEventListener('click', ()=>{ const cardId=document.getElementById('txCard').value; const date=document.getElementById('txDate').value; const amount=parseFloat(document.getElementById('txAmount').value||0); const desc=document.getElementById('txDesc').value||''; if(!cardId){ alert('Select card'); return; } if(!date){ alert('Pick date'); return; } if(!amount || amount<=0){ alert('Enter amount'); return; } const editing = localStorage.getItem('__editing_tx'); let arr=getTxs()||[]; if(editing){ const idx=arr.findIndex(x=>x.id===editing); if(idx>=0){ arr[idx].bankId=cardId; arr[idx].date=date; arr[idx].amount=amount; arr[idx].desc=desc;} localStorage.removeItem('__editing_tx'); } else { arr.push({ id: uid(), bankId: cardId, date: date, amount: amount, desc: desc }); } save(TX_KEY_NAME, arr); renderTable(); try{ if(typeof syncToServer === 'function') syncToServer(); }catch(e){} document.getElementById('txCard').value=''; document.getElementById('txDate').value=''; document.getElementById('txAmount').value=''; document.getElementById('txDesc').value=''; });
populateCards(); renderTable();
</script>
</body></html>
