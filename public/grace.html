<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Grace Analysis â€” GraceWise</title>
  <link rel="stylesheet" href="/theme.css">
  <link rel="stylesheet" href="https://unpkg.com/@tabler/icons-webfont@1.39.1/tabler-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="/core.js"></script>
</head>
<body>
  <div class="header">
    <div style="display:flex;gap:12px;align-items:center">
      <div class="logo">GW</div>
      <div><div style="font-weight:700;font-size:18px">GraceWise</div><div class="small">Grace Analysis</div></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center"><button onclick="location.href='/cards'">Cards</button></div>
  </div>

  <div class="container">
    <div class="panel">
      <h3>Grace Calculator</h3>
      <div class="small">Choose a card and purchase date to analyze your grace period and overdue status.</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <select id="analysisCard" style="flex:1"></select>
        <input id="analysisDate" type="date" style="width:200px">
        <button id="calcBtn">Calculate</button>
      </div>
      <div id="analysisSummary" style="margin-top:14px"></div>
      <div class="progress"><div id="analysisProgress" class="progress-bar"></div></div>
      <div style="margin-top:12px"><canvas id="weekChart" class="chart"></canvas></div>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item" data-path="/cards" onclick="location.href='/cards'"><span class="icon ti ti-credit-card"></span>Cards</div>
    <div class="nav-item" data-path="/transactions" onclick="location.href='/transactions'"><span class="icon ti ti-wallet"></span>Transactions</div>
    <div class="nav-item active" data-path="/grace" onclick="location.href='/grace'"><span class="icon ti ti-chart-bar"></span>Grace</div>
    <div class="nav-item" data-path="/settings" onclick="location.href='/settings'"><span class="icon ti ti-settings"></span>Settings</div>
  </div>

<script>
applyTheme();
setActiveNav('/grace');

function renderAnalysisCards(){
  const sel=document.getElementById('analysisCard');
  sel.innerHTML='';
  load(BANKS_KEY).forEach(b=>{
    const o=document.createElement('option');
    o.value=b.id;
    o.textContent=b.name;
    sel.appendChild(o);
  });
}

let weekChart=null;
function buildWeekChart(due){
  const ctx=document.getElementById('weekChart').getContext('2d');
  const today=new Date();
  const start=new Date(today);
  start.setDate(today.getDate()-today.getDay());
  const labels=[],data=[];
  for(let i=0;i<7;i++){
    const d=new Date(start);
    d.setDate(start.getDate()+i);
    labels.push(d.toLocaleDateString('en-US',{weekday:'short'}));
    data.push(daysDiff(d,due));
  }
  if(weekChart) weekChart.destroy();
  weekChart=new Chart(ctx,{
    type:'bar',
    data:{labels,datasets:[{data,backgroundColor:'linear-gradient(90deg,#005BAC,#F37021)'}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
}

function update(){
  const banks=load(BANKS_KEY);
  if(!banks.length){
    document.getElementById('analysisSummary').innerHTML='<div class="small">No cards</div>';
    return;
  }
  const sel=document.getElementById('analysisCard');
  const bank=banks.find(b=>b.id===sel.value)||banks[0];
  const dateInput=document.getElementById('analysisDate').value;
  if(!dateInput){document.getElementById('analysisSummary').innerHTML='<div class="small">Select date</div>';return;}
  const purchase=new Date(dateInput+'T00:00:00');
  const due=parseDate(bank.due);
  const grace=daysDiff(purchase,due);
  const overdue=Math.max(0,daysDiff(due,new Date()));
  const html=[];
  html.push(`<div><strong>Purchase:</strong> ${fmt(purchase)}</div>`);
  html.push(`<div><strong>Payment due:</strong> ${fmt(due)}</div>`);
  html.push(`<div><strong>Grace period:</strong> ${grace} days</div>`);
  if(overdue>0) html.push(`<div style="color:#b91c1c"><strong>Overdue by ${overdue} days</strong></div>`);
  else html.push(`<div><strong>Grace ends in:</strong> ${daysDiff(new Date(),due)} days</div>`);
  document.getElementById('analysisSummary').innerHTML = html.join('');
  const totalWindow=grace>0?grace:1;
  const elapsed=daysDiff(purchase,new Date());
  const prog=Math.min(100,Math.max(0,Math.round((elapsed/totalWindow)*100)));
  const bar=document.getElementById('analysisProgress');
  bar.style.width=prog+'%';
  bar.style.background='linear-gradient(90deg,#005BAC,#F37021)';
  buildWeekChart(due);
}

document.getElementById('calcBtn').addEventListener('click',update);
document.addEventListener('DOMContentLoaded',renderAnalysisCards);
</script>
</body>
</html>